<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¿è¡Œå›¾</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #020e25; /* æ·±è‰²é¡µé¢èƒŒæ™¯ */
    color: #d1d5db; /* é»˜è®¤æµ…è‰²æ–‡å­— */
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    text-align: center;
    color: #e5e7eb; /* æ ‡é¢˜æµ…è‰² */
    margin-bottom: 15px;
  }

  /* --- Warning Banner Styles --- */
  .warning-banner-container { width: 95%; max-width: 1200px; margin-bottom: 15px; }
  .warning-banner { padding: 10px 15px; border-radius: 6px; text-align: center; font-size: 0.95em; transition: background-color 0.3s ease; border: 1px solid transparent; }
  .warning-banner .icon { margin-right: 8px; }
  .warning-banner a { color: inherit; font-weight: bold; text-decoration: underline; margin-left: 15px; cursor: pointer;}
  .warning-banner.severity-none { background-color: #28a745; border-color: #28a745; color: white; }
  .warning-banner.severity-low { background-color: #17a2b8; border-color: #17a2b8; color: white; }
  .warning-banner.severity-medium { background-color: #ffc107; border-color: #ffc107; color: #212529; }
  .warning-banner.severity-high { background-color: #dc3545; border-color: #dc3545; color: white; }

  /* --- Warning Details Panel Styles --- */
  .warning-details-panel-container { position: fixed; top: 0; right: -390px; width: 380px; height: 100%; background-color: #2d333a; border-left: 1px solid #444c56; box-shadow: -3px 0 15px rgba(0,0,0,0.25); z-index: 1050; transition: right 0.35s ease-in-out; display: flex; flex-direction: column; }
  .warning-details-panel-container.open { right: 0px; }
  .warning-panel-header { padding: 15px 20px; border-bottom: 1px solid #444c56; display: flex; justify-content: space-between; align-items: center; }
  .warning-panel-header h3 { margin: 0; font-size: 1.2em; color: #e5e7eb; }
  .warning-panel-header .panel-icon { margin-right: 8px;}
  #closeWarningPanelBtn { background: none; border: none; color: #9ea7b3; font-size: 1.8em; line-height: 1; cursor: pointer; padding: 0 5px; }
  #closeWarningPanelBtn:hover { color: #e5e7eb; }
  .warning-list-ui { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
  .warning-list-ui li { padding: 12px 20px; border-bottom: 1px solid #373e47; font-size: 0.9em; display: flex; align-items: flex-start; }
  .warning-list-ui li:last-child { border-bottom: none; }
  .warning-list-ui .item-icon { margin-right: 12px; font-size: 1.3em; line-height: 1.3; padding-top: 2px; }
  .warning-list-ui .message-content .summary { font-weight: bold; display: block; margin-bottom: 4px; font-size: 0.95em; }
  .warning-list-ui .message-content .details { font-size: 0.85em; color: #adb5bd; margin-bottom: 5px; white-space: pre-wrap; }
  .warning-list-ui .message-content .meta { font-size: 0.75em; color: #868e96; }
  .warning-list-ui .message-content .meta .locate-on-chart-btn { color: #63a4ff; text-decoration: none; cursor: pointer; }
  .warning-list-ui .message-content .meta .locate-on-chart-btn:hover {text-decoration: underline;}
  .warning-item.severity-high .item-icon, .warning-item.severity-high .summary { color: #f48fb1; }
  .warning-item.severity-medium .item-icon, .warning-item.severity-medium .summary { color: #ffb74d; }
  .warning-item.severity-low .item-icon, .warning-item.severity-low .summary { color: #81d4fa; }
  .warning-item.severity-info .item-icon, .warning-item.severity-info .summary { color: #90caf9; }

  /* --- Legend Styles --- */
  .legend { display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 25px; padding: 12px 15px; background-color: #2d333a; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .legend-item { display: flex; align-items: center; margin-right: 20px; margin-bottom: 5px; font-size: 14px; color: #c5c8cc; }
  .legend-item:last-child { margin-right: 0; }
  .legend-line { width: 35px; height: 5px; margin-right: 10px; border-radius: 2px; }
  .legend-demand { background-color: #FFC107; }
  .legend-planned { background-color: #B0BEC5; }
  .legend-planned-chartered { background-color: #FF9800; border-top: 2px dashed #fff; }
  .legend-actual { background-color: #26C6DA; }
  .legend-actual-chartered { background-color: #FF9800; border-top: 2px dashed #fff; }
  .legend-grid { background-color: #ADE1FF; }
  .legend-ship {
    width: 35px;
    height: 15px;
    margin-right: 10px;
    position: relative;
    display: inline-block;
  }

  .legend-ship.owned {
    background-color: #26C6DA;
    clip-path: polygon(0% 50%, 20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%);
  }

  .legend-ship.chartered {
    background-color: #26C6DA;
    clip-path: polygon(0% 50%, 20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%);
    border: 2px dashed #fff;
  }

  /* --- Chart Container & Table Styles --- */
  .gantt-chart-title { text-align: center; margin-bottom: 15px; }
  .gantt-chart-title h2, .gantt-chart-title h4 { color: #e5e7eb; margin: 5px 0; }
  .gantt-chart-title h2 { font-size: 1.4em; }
  .gantt-chart-title h4 { font-size: 0.9em; font-weight: normal; color: #adb5bd; }

  .chart-display-container {
    width: 95%;
    max-width: 1200px;
    background-color: #051532;
    border: 1px solid #30363d;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto; /* Allow horizontal scrolling for wide tables */
    display: flex; /* Added for centering table wrapper */
    justify-content: center; /* Added for centering table wrapper */
  }

  /* è¿è¡Œçº¿æ‚¬åœæç¤ºæ¡†æ ·å¼ */
  .custom-tooltip {
    position: absolute;
    padding: 8px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #333;
    border-radius: 4px;
    pointer-events: none;
    z-index: 1000;
    font-size: 12px;
    display: none;
    text-align: center;
    white-space: pre-line;
    color: #222;
  }

  /* ä¸ºè·¯å¾„æ·»åŠ æ‚¬åœå®½åº¦ */
  .planned-line-svg, .actual-line-svg, .demand-line-svg {
    stroke-width: 2;
    cursor: pointer;
    pointer-events: all;
  }

  .planned-line-svg.hovered, .actual-line-svg.hovered, .demand-line-svg.hovered {
    stroke-width: 3;
    stroke-opacity: 1;
    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
  }

  .chart-table-wrapper {
    position: relative;
    /* display: inline-block; Removed, let container center it */
  }
  #mainGanttTable {
    border-collapse: collapse;
    table-layout: fixed;
    border: 2px solid #ADE1FF;
    color: #c5c8cc;
  }
  #mainGanttTable th, #mainGanttTable td {
    border: 1px solid rgba(173, 225, 255, 0.3); /* ç»†ä¸”æ·¡ */
    padding: 0;
    margin: 0;
    box-sizing: border-box;
    text-align: center;
    vertical-align: middle;
    font-size: 11px;
  }
  .table-header-cell { height: 30px; min-height: 30px; font-weight: bold; }
  .port-name-cell { width: 80px; min-width: 80px; font-weight: bold; }
  .state-name-cell { width: 70px; min-width: 70px; border-left: 2px solid #ADE1FF !important; border-right: 2px solid #ADE1FF !important; }
  .time-slot-cell { width: 25px; min-width: 25px; height: 25px; min-height: 25px; }
  .time-slot-cell.dashed-right { border-right: 2px dashed #ADE1FF !important; }
  .time-slot-cell.dashed-left { border-left: 1px dashed #ADE1FF !important; }
  .empty-spacer-row td { height: 10px !important; min-height: 10px !important; }
  .empty-spacer-row.large-gap td { height: 60px !important; min-height: 60px !important; }
  .top-border-strong    { border-top:    2px solid #ADE1FF !important; }
  .bottom-border-strong { border-bottom: 2px solid #ADE1FF !important; }
  .right-border-strong  { border-right:  2px solid #ADE1FF !important; }
  .left-border-strong   { border-left:   2px solid #ADE1FF !important; }

  #ganttSvgOverlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }
  #ganttSvgOverlay path, #ganttSvgOverlay line {
    pointer-events: auto;
    stroke-linecap: round;
  }
  .demand-line-svg { stroke: #FFC107; stroke-width: 2.5; fill:none; stroke-dasharray: 6, 4; }
  .planned-line-svg { stroke: #B0BEC5; stroke-width: 2.5; fill:none; }
  .planned-line-svg.chartered { stroke: #FF9800; stroke-dasharray: 8, 4; }
  .actual-line-svg { stroke: #26C6DA; stroke-width: 3; fill:none; }
  .actual-line-svg.chartered { stroke: #FF9800; stroke-dasharray: 8, 4; }
  .line-label-svg { font-size: 9px; fill: #e1e4e8; text-anchor: middle; pointer-events: none; paint-order: stroke; stroke: #24292e; stroke-width: 3px; stroke-linejoin: round; }

  /* --- On-Chart Warning Visuals for SVG --- */
  .warning-icon-on-svg { font-size: 12px; cursor: help; text-anchor: start; pointer-events: auto; }
  .warning-icon-on-svg.severity-high { fill: #f48fb1; }
  .warning-icon-on-svg.severity-medium { fill: #ffb74d; }
  .warning-icon-on-svg.severity-low { fill: #81d4fa; }
  .warning-icon-on-svg.severity-info { fill: #90caf9; }
  .area-warning-overlay-svg { opacity: 0.35; }
  .port-closure-overlay-svg { fill: #c62828; }
  .sea-condition-overlay-svg-high { fill: #d32f2f; }
  .sea-condition-overlay-svg-medium { fill: #ef6c00; }
  .sea-condition-overlay-svg-low { fill: #0277bd; }
  .equipment-failure-overlay-svg { fill: #7b1fa2; }
  .channel-congestion-overlay-svg { fill: #00897b; }
  .area-warning-text-svg { font-size: 11px; fill: #ffffff; text-anchor: middle; dominant-baseline: middle; pointer-events: none; font-weight: bold; paint-order: stroke; stroke: rgba(0,0,0,0.7); stroke-width: 2px; stroke-linejoin: round; }

</style>
</head>
<body>


<div class="warning-banner-container">
    <div id="globalWarningBanner" class="warning-banner severity-none">
        <span class="icon">â„¹ï¸</span> <span id="warningSummaryText">æ­£åœ¨åŠ è½½é¢„è­¦ä¿¡æ¯...</span>
        <a id="toggleWarningPanelBtn" style="display:none;">æŸ¥çœ‹è¯¦æƒ… &raquo;</a>
    </div>
</div>

<div id="warningDetailsPanelContainer" class="warning-details-panel-container">
    <div class="warning-panel-header">
        <h3><span id="panelIcon" class="panel-icon">âš ï¸</span>é¢„è­¦ä¿¡æ¯åˆ—è¡¨</h3>
        <button id="closeWarningPanelBtn" title="å…³é—­é¢æ¿">&times;</button>
    </div>
    <ul id="warningListUL" class="warning-list-ui"></ul>
</div>

<div class="legend">
  <div class="legend-item"><div class="legend-line legend-demand"></div><span>éœ€æ±‚çº¿</span></div>
  <div class="legend-item"><div class="legend-line legend-planned"></div><span>æ•£è´§èˆ¹è®¡åˆ’çº¿</span></div>
  <div class="legend-item"><div class="legend-line legend-planned-chartered"></div><span>ç§Ÿèˆ¹è®¡åˆ’çº¿</span></div>
  <div class="legend-item"><div class="legend-line legend-actual"></div><span>æ•£è´§èˆ¹å®é™…çº¿</span></div>
  <div class="legend-item"><div class="legend-line legend-actual-chartered"></div><span>ç§Ÿèˆ¹å®é™…çº¿</span></div>
</div>

<div class="gantt-chart-title">
    <h2 id="chartMainTitle">æµ·è¿è¿è¡Œå›¾ (2024å¹´3æœˆä»½)</h2>
    <h4 id="chartSubTitle">å›½å®¶èƒ½æºé›†å›¢èˆªè¿å…¬å¸â€“åä¸­/ç¥çš–èˆ¹èˆ¶è¿è¡Œå›¾</h4>
</div>

<div class="chart-display-container">
    <div id="chartTableWrapper" class="chart-table-wrapper">
        <table id="mainGanttTable"></table>
        <svg id="ganttSvgOverlay">
            <defs>
                <marker id="arrow-demand-svg" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#FFC107" /></marker>
                <marker id="arrow-planned-svg" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#B0BEC5" /></marker>
                <marker id="arrow-actual-svg" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#26C6DA" /></marker>
            </defs>
            <g id="areaWarningOverlaysGroupSvg"></g>
            <g id="trainPathsGroupSvg"></g>
            <g id="discreteWarningIconsGroupSvg"></g>
        </svg>
    </div>
</div>

<script>
  const svgNS = "http://www.w3.org/2000/svg";
  const mainGanttTable = document.getElementById('mainGanttTable');
  const ganttSvgOverlay = document.getElementById('ganttSvgOverlay');
  const trainPathsGroupSvg = document.getElementById('trainPathsGroupSvg');
  const areaWarningOverlaysGroupSvg = document.getElementById('areaWarningOverlaysGroupSvg');

  const warningBannerEl = document.getElementById('globalWarningBanner');
  const warningSummaryTextEl = document.getElementById('warningSummaryText');
  const toggleWarningPanelBtnEl = document.getElementById('toggleWarningPanelBtn');
  const warningPanelContainerEl = document.getElementById('warningDetailsPanelContainer');
  const closeWarningPanelBtnEl = document.getElementById('closeWarningPanelBtn');
  const warningListUlEl = document.getElementById('warningListUL');
  const panelIconEl = document.getElementById('panelIcon');

  const MOCK_WARNINGS = [
    { id: "W001", severity: "high", type: "æ»æœŸ", serviceId: "VESSEL_B_actual", atPort: "é»„éª…", message: "ç§Ÿèˆ¹01ï¼ˆå®é™…ï¼‰åœ¨é»„éª…æ»æœŸ", details: "å·²è¶…3å°æ—¶", timestamp: "10:00" },
    { id: "W002", severity: "medium", type: "æ™šç‚¹", serviceId: "VESSEL_A_actual", atPort: "ç¥çš–èƒ½æº", message: "ç¥å562ï¼ˆå®é™…ï¼‰åœ¨ç¥çš–èƒ½æºæ™šç‚¹", details: "é¢„è®¡æ™šç‚¹30åˆ†é’Ÿ", timestamp: "14:00" },
    { id: "W003", severity: "medium", type: "æ°”è±¡", serviceId: "VESSEL_A_actual", atPort: "åä¸­é”€å”®", message: "ç¥å562ï¼ˆå®é™…ï¼‰é‡åˆ°å¤§é£å¤©æ°”", details: "é˜µé£8çº§ï¼Œæ³¨æ„å®‰å…¨", timestamp: "15:00" },
    { id: "W004", severity: "high", type: "ç‰¹æ®Šæµ·å†µ", serviceId: "VESSEL_B_actual", atPort: "ç¥çš–èƒ½æº", message: "ç§Ÿèˆ¹01ï¼ˆå®é™…ï¼‰é‡åˆ°ç‰¹æ®Šæµ·å†µ", details: "æµ·æµªè¾ƒå¤§ï¼Œä½œä¸šæš‚åœ", timestamp: "16:00" },
    { id: "W005", severity: "high", type: "å°æ¸¯", entityType: "port", entityName: "é»„éª…", message: "é»„éª…æ¸¯ä¸´æ—¶å°æ¸¯", details: "å› æ¶åŠ£å¤©æ°”ä¸´æ—¶å°æ¸¯", startTime: "2024-03-01T14:00:00", endTime: "2024-03-01T16:00:00" },
    { id: "W006", severity: "medium", type: "è®¾å¤‡æ•…éšœ", serviceId: "VESSEL_A_actual", atPort: "ç¥çš–èƒ½æº", message: "ç¥å562ï¼ˆå®é™…ï¼‰è£…å¸è®¾å¤‡æ•…éšœ", details: "1å·è£…èˆ¹æœºæ•…éšœï¼Œé¢„è®¡ç»´ä¿®2å°æ—¶", timestamp: "13:00" },
    { id: "W007", severity: "low", type: "èˆªé“æ‹¥å µ", serviceId: "VESSEL_B_actual", atPort: "å¤©æ´¥", message: "ç§Ÿèˆ¹01ï¼ˆå®é™…ï¼‰èˆªé“æ‹¥å µ", details: "è¿›æ¸¯èˆªé“æ‹¥å µï¼Œé¢„è®¡ç­‰å¾…1å°æ—¶", timestamp: "14:30" }
  ];

  const portConfig = [
      { name: 'å¤©æ´¥', states: ['äº¤æ¥|å¾…ç¦»', 'è£…èˆ¹', 'æŠµæ¸¯|å¾…è£…'] },
      { name: 'é»„éª…', states: ['äº¤æ¥|å¾…ç¦»', 'è£…èˆ¹', 'æŠµæ¸¯|å¾…è£…'] },
      { name: 'ç¤¾ä¼šæ¸¯', states: ['äº¤æ¥|å¾…ç¦»', 'è£…èˆ¹', 'æŠµæ¸¯|å¾…è£…'], largeGapAfter: true },
      { name: 'åä¸­é”€å”®', states: ['æŠµæ¸¯å¾…å¸', 'è£…èˆ¹', 'äº¤æ¥å¾…ç¦»'] },
      { name: 'ç¥çš–èƒ½æº', states: ['æŠµæ¸¯å¾…å¸', 'è£…èˆ¹', 'äº¤æ¥å¾…ç¦»'] }
  ];
  const TIME_COLUMNS = 32;
  const TIME_AXIS_LABEL_INTERVAL = 4;
  const CHART_START_HOUR = 7;
  const CHART_END_HOUR = 23;
  const HOURS_PER_COLUMN = (CHART_END_HOUR - CHART_START_HOUR) / TIME_COLUMNS;

  const cellInfoMap = new Map();

  const trainServices = [
    { id: "VESSEL_C_demand", type: "demand", label: "ç¥å563", vesselType: "æ•£è´§èˆ¹", tonnage: "50000å¨", segments: [
        { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 8.0 }, { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 9.0 },
        { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 9.0 }, { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 10.0 },
        { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 9.0 }, { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 10.0 },
        { port: "é»„çƒ¨", state: "æŠµæ¸¯|å¾…è£…", time: 10.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 13.0 }, { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 14.0 },
        { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 14.0 }, { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 15.0 },
        { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 15.0 }, { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 16.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 16.0 }
    ]},
    { id: "VESSEL_D_demand", type: "demand", label: "ç§Ÿèˆ¹02", vesselType: "æ•£è´§èˆ¹", tonnage: "45000å¨", segments: [
        { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 10.0 }, { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 11.0 },
        { port: "é»„éª…", state: "è£…èˆ¹", time: 11.0 }, { port: "é»„éª…", state: "è£…èˆ¹", time: 12.0 },
        { port: "é»„éª…", state: "äº¤æ¥|å¾…ç¦»", time: 12.0 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 15.0 }, { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 16.0 },
        { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 16.0 }, { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 17.0 },
        { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 17.0 }, { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 18.0 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 18.0 }
    ]},
    { id: "VESSEL_A_plan", type: "planned", label: "ç¥å562", vesselType: "æ•£è´§èˆ¹", tonnage: "50000å¨", segments: [
        { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 7.5 }, { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 8.5 },
        { port: "é»„éª…", state: "è£…èˆ¹", time: 8.5 }, { port: "é»„éª…", state: "è£…èˆ¹", time: 9.5 },
        { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 8.5 }, { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 9.5 },
        { port: "é»„çƒ¨", state: "æŠµæ¸¯|å¾…è£…", time: 9.5 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 12.0 }, { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 13.0 },
        { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 13.0 }, { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 14.0 },
        { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 14.0 }, { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 15.0 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 15.0 },
        { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 18.0 }, { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 20.0 },
        { port: "é»„éª…", state: "è£…èˆ¹", time: 20.0 }, { port: "é»„éª…", state: "è£…èˆ¹", time: 21.0 },
        { port: "é»„éª…", state: "äº¤æ¥|å¾…ç¦»", time: 21.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 26.0 }, { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 28.0 },
        { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 26.0 }, { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 27.0 },
        { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 27.0 }, { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 28.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 28.0 }
    ]},
    { id: "VESSEL_B_plan", type: "planned", label: "ç§Ÿèˆ¹01", vesselType: "æ•£è´§èˆ¹", tonnage: "45000å¨", segments: [
        { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 14.5 }, { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 15.5 },
        { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 15.5 }, { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 16.5 },
        { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 15.5 }, { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 16.5 },
        { port: "é»„çƒ¨", state: "æŠµæ¸¯|å¾…è£…", time: 16.5 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 19.5 }, { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 20.5 },
        { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 20.5 }, { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 21.5 },
        { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 21.5 }, { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 22.5 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 22.5 }
    ]},
    { id: "VESSEL_A_actual", type: "actual", label: "ç¥å562", vesselType: "æ•£è´§èˆ¹", tonnage: "50000å¨", segments: [
        { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 7.0 }, { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 8.0 },
        { port: "é»„éª…", state: "è£…èˆ¹", time: 8.0 }, { port: "é»„éª…", state: "è£…èˆ¹", time: 9.0 },
        { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 8.0 }, { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 9.0 },
        { port: "é»„çƒ¨", state: "æŠµæ¸¯|å¾…è£…", time: 9.0 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 11.5 }, { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 12.5 },
        { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 12.5 }, { port: "ç¥çš–èƒ½æº", state: "è£…èˆ¹", time: 13.5 },
        { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 13.5 }, { port: "ç¥çš–èƒ½æº", state: "äº¤æ¥|å¾…ç¦»", time: 14.5 },
        { port: "ç¥çš–èƒ½æº", state: "æŠµæ¸¯|å¾…è£…", time: 14.5 },
        { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 17.5 }, { port: "é»„éª…", state: "æŠµæ¸¯|å¾…è£…", time: 19.5 },
        { port: "é»„éª…", state: "è£…èˆ¹", time: 19.5 }, { port: "é»„éª…", state: "è£…èˆ¹", time: 20.5 },
        { port: "é»„éª…", state: "äº¤æ¥|å¾…ç¦»", time: 20.5 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 25.5 }, { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 27.5 },
        { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 25.5 }, { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 26.5 },
        { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 26.5 }, { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 27.5 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 27.5 }
    ]},
    { id: "VESSEL_B_actual", type: "actual", label: "ç§Ÿèˆ¹01", vesselType: "æ•£è´§èˆ¹", tonnage: "45000å¨", segments: [
        { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 14.0 }, { port: "å¤©æ´¥", state: "æŠµæ¸¯|å¾…è£…", time: 15.0 },
        { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 15.0 }, { port: "å¤©æ´¥", state: "è£…èˆ¹", time: 16.0 },
        { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 15.0 }, { port: "é»„çƒ¨", state: "äº¤æ¥|å¾…ç¦»", time: 16.0 },
        { port: "é»„çƒ¨", state: "æŠµæ¸¯|å¾…è£…", time: 16.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 19.0 }, { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 20.0 },
        { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 20.0 }, { port: "åä¸­é”€å”®", state: "è£…èˆ¹", time: 21.0 },
        { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 21.0 }, { port: "åä¸­é”€å”®", state: "äº¤æ¥|å¾…ç¦»", time: 22.0 },
        { port: "åä¸­é”€å”®", state: "æŠµæ¸¯|å¾…è£…", time: 22.0 }
    ]}
  ];

  function getIconCharForWarning(type, severity) { return type === 'å°æ¸¯' ? 'â›”' : type === 'ç‰¹æ®Šæµ·å†µ' ? 'ğŸŒŠ' : (type === 'æ»æœŸ' || type === 'æ™šç‚¹') ? 'â°' : type === 'æ°”è±¡' ? 'ğŸŒ¦ï¸' : severity === 'high' ? 'â—' : severity === 'medium' ? 'âš ï¸' : 'â„¹ï¸';}
  function getSeverityClass(severity) { return `severity-${severity || 'info'}`;}
  function displayWarnings(warnings) { /* ... (same as previous) ... */
    if (warnings.length > 0) {
        let highSeverityCount = warnings.filter(w => w.severity === 'high').length;
        let mediumSeverityCount = warnings.filter(w => w.severity === 'medium').length;
        let overallSeverity = 'low';
        if (warnings.some(w => w.severity === 'info') && !highSeverityCount && !mediumSeverityCount && !warnings.some(w => w.severity === 'low')) overallSeverity = 'info';
        if (mediumSeverityCount > 0) overallSeverity = 'medium';
        if (highSeverityCount > 0) overallSeverity = 'high';

        warningBannerEl.className = 'warning-banner ' + getSeverityClass(overallSeverity);
        panelIconEl.textContent = getIconCharForWarning(null, overallSeverity);
        warningSummaryTextEl.innerHTML = `å½“å‰æœ‰ <b>${warnings.length}</b> æ¡é¢„è­¦ä¿¡æ¯` + (highSeverityCount > 0 ? ` (å« <b>${highSeverityCount}</b> æ¡é«˜çº§åˆ«)` : '');
        toggleWarningPanelBtnEl.style.display = 'inline';
    } else {
        warningBannerEl.className = 'warning-banner severity-none';
        panelIconEl.textContent = 'âœ”ï¸';
        warningSummaryTextEl.innerHTML = '<span class="icon">âœ”ï¸</span> å½“å‰æ— é¢„è­¦ä¿¡æ¯';
        toggleWarningPanelBtnEl.style.display = 'none';
        warningPanelContainerEl.classList.remove('open');
    }
    warningListUlEl.innerHTML = '';
    warnings.sort((a,b) => { const order = { high: 3, medium: 2, low: 1, info: 0 }; return (order[b.severity] || 0) - (order[a.severity] || 0); })
    .forEach(w => {
        const li = document.createElement('li');
        li.className = 'warning-item ' + getSeverityClass(w.severity);
        li.dataset.warningId = w.id;
        if(w.serviceId) li.dataset.targetServiceId = w.serviceId;
        if(w.entityName) li.dataset.targetEntityName = w.entityName;
        li.innerHTML = `<span class="item-icon">${getIconCharForWarning(w.type, w.severity)}</span><div class="message-content"><span class="summary">${w.message}</span><span class="details">${w.details}</span><span class="meta">${w.timestamp ? `æ—¶é—´: ${w.timestamp} | ` : ''}<a href="#" class="locate-on-chart-btn" title="å®šä½é¢„è­¦ï¼ˆæ¨¡æ‹Ÿï¼‰">å®šä½å›¾ä¸Š</a></span></div>`;
        warningListUlEl.appendChild(li);
    });
  }
  toggleWarningPanelBtnEl.addEventListener('click', (e) => { e.preventDefault(); warningPanelContainerEl.classList.toggle('open'); });
  closeWarningPanelBtnEl.addEventListener('click', () => { warningPanelContainerEl.classList.remove('open'); });
  warningListUlEl.addEventListener('click', function(event) { if (event.target.classList.contains('locate-on-chart-btn')) { event.preventDefault(); const listItem = event.target.closest('.warning-item'); const warningId = listItem.dataset.warningId; console.log(`Action: Locate warning ${warningId} on chart.`); const specificWarning = MOCK_WARNINGS.find(w => w.id === warningId); if (specificWarning) { drawAreaWarnings([specificWarning]); } } });

  function createGanttTable() { /* ... (same as previous, ensure cell IDs are set) ... */
    mainGanttTable.innerHTML = ''; cellInfoMap.clear(); let absoluteRowIndex = 0;
    const headerRow = mainGanttTable.insertRow(); absoluteRowIndex++;
    const mainHeaderCell = headerRow.insertCell(); mainHeaderCell.colSpan = 2;
    mainHeaderCell.textContent = 'æ¸¯å£/çŠ¶æ€'; mainHeaderCell.className = 'table-header-cell right-border-strong';
    for (let i = 0; i < TIME_COLUMNS; i++) {
        const cell = headerRow.insertCell();
        // ä¸æ˜¾ç¤ºæ—¶é—´æ–‡å­—
        // if (i % TIME_AXIS_LABEL_INTERVAL === 0) {
        //     const hour = CHART_START_HOUR + i * HOURS_PER_COLUMN;
        //     cell.textContent = `${Math.floor(hour).toString().padStart(2,'0')}:${Math.round((hour % 1)*60).toString().padStart(2,'0')}`;
        // }
        cell.className = 'time-slot-cell table-header-cell';
        if ((i + 1) % 10 === 0 && i < TIME_COLUMNS -1) cell.classList.add('dashed-right');
    }
    const endHeaderCell = headerRow.insertCell(); endHeaderCell.textContent = 'æ¸¯å£é‡å¤'; endHeaderCell.className = 'table-header-cell left-border-strong';
    portConfig.forEach((port) => {
        port.states.forEach((state, stateIdx) => {
            const row = mainGanttTable.insertRow(); row.dataset.absoluteRowIndex = absoluteRowIndex; absoluteRowIndex++;
            if (stateIdx === 0) { const portCell = row.insertCell(); portCell.rowSpan = port.states.length; portCell.textContent = port.name; portCell.className = 'port-name-cell right-border-strong'; }
            const stateCell = row.insertCell(); stateCell.textContent = state; stateCell.className = 'state-name-cell';
            if (stateIdx === 0) row.classList.add('top-border-strong'); if (stateIdx === port.states.length - 1) row.classList.add('bottom-border-strong');
            for (let colIdx = 0; colIdx < TIME_COLUMNS; colIdx++) { const cell = row.insertCell(); cell.className = 'time-slot-cell'; cell.id = `cell_${port.name}_${state.replace(/[^a-zA-Z0-9\-]/g,'-')}_${colIdx}`; if ((colIdx + 1) % 10 === 0 && colIdx < TIME_COLUMNS -1) cell.classList.add('dashed-right');}
            if (stateIdx === 0) { const endPortCell = row.insertCell(); endPortCell.rowSpan = port.states.length; endPortCell.textContent = port.name; endPortCell.className = 'port-name-cell left-border-strong';}
        });
        const emptyRow = mainGanttTable.insertRow(); emptyRow.dataset.absoluteRowIndex = absoluteRowIndex; absoluteRowIndex++; emptyRow.className = 'empty-spacer-row'; if (port.largeGapAfter) emptyRow.classList.add('large-gap');
        for (let i = 0; i < 2 + TIME_COLUMNS + 1; i++) { const cell = emptyRow.insertCell(); if (i===0) cell.className = 'port-name-cell right-border-strong'; else if (i===1) cell.className = 'state-name-cell'; else if (i === 2 + TIME_COLUMNS) cell.className = 'port-name-cell left-border-strong'; else cell.className = 'time-slot-cell'; if (i > 1 && i < 2 + TIME_COLUMNS && (i - 2 + 1) % 10 === 0 && (i-2) < TIME_COLUMNS -1 ) cell.classList.add('dashed-right'); }
    });
    requestAnimationFrame(() => {
        ganttSvgOverlay.style.width = `${mainGanttTable.offsetWidth}px`; ganttSvgOverlay.style.height = `${mainGanttTable.offsetHeight}px`;
        ganttSvgOverlay.setAttribute('viewBox', `0 0 ${mainGanttTable.offsetWidth} ${mainGanttTable.offsetHeight}`);
        for (const port of portConfig) {
            for (const state of port.states) {
                for (let colIdx = 0; colIdx < TIME_COLUMNS; colIdx++) {
                    const cellId = `cell_${port.name}_${state.replace(/[^a-zA-Z0-9\-]/g,'-')}_${colIdx}`;
                    const cellElement = document.getElementById(cellId);
                    if (cellElement) {
                        const cellX = cellElement.offsetLeft + cellElement.offsetWidth / 2;
                        const cellY = cellElement.offsetTop + cellElement.offsetHeight / 2;
                        cellInfoMap.set(cellId, { element: cellElement, centerX: cellX, centerY: cellY });
                    }
                }
            }
        }
        drawTrainPathsAndVesselWarnings();
        drawAreaWarnings(MOCK_WARNINGS.filter(w => w.type === 'å°æ¸¯' || w.type === 'ç‰¹æ®Šæµ·å†µ'));
    });
  }

  function getCellCenter(portName, stateName, timeColIdx) { const cellKey = `cell_${portName}_${stateName.replace(/[^a-zA-Z0-9\-]/g,'-')}_${timeColIdx}`; return cellInfoMap.get(cellKey); }
  function serviceTimeToColIdx(timeInHours) { let colIdx = Math.round((timeInHours - CHART_START_HOUR) / HOURS_PER_COLUMN); return Math.max(0, Math.min(TIME_COLUMNS - 1, colIdx)); }
  function isoToColIdx(isoString) { if (!isoString) return null; const date = new Date(isoString); let hours = date.getHours() + date.getMinutes()/60; return serviceTimeToColIdx(hours); }

  function drawTrainPathsAndVesselWarnings() {
    trainPathsGroupSvg.innerHTML = '';
    // åˆ›å»ºæ‚¬åœæç¤ºæ¡†
    let tooltip = document.createElement('div');
    tooltip.className = 'custom-tooltip';
    document.body.appendChild(tooltip);

    trainServices.forEach(service => {
        const pathPoints = [];
        // åªåœ¨å®é™…çº¿ä¸Šæ˜¾ç¤ºé¢„è­¦
        const warningSegments = (service.type === 'actual') ? MOCK_WARNINGS.filter(w => w.serviceId === service.id) : [];
        if (service.segments) {
            service.segments.forEach((segment, idx) => {
                const cellInfo = getCellCenter(segment.port, segment.state, serviceTimeToColIdx(segment.time));
                if (cellInfo) {
                    pathPoints.push(`${cellInfo.centerX},${cellInfo.centerY}`);
                    // æ£€æŸ¥æ­¤æ®µæ˜¯å¦æœ‰é¢„è­¦
                    const warningHere = warningSegments.find(w => w.atPort === segment.port);
                    if (warningHere) {
                        const iconChar = getIconCharForWarning(warningHere.type, warningHere.severity);
                        const icon = document.createElementNS(svgNS, 'text');
                        icon.setAttribute('x', cellInfo.centerX + 8);
                        icon.setAttribute('y', cellInfo.centerY - 8);
                        icon.setAttribute('class', 'warning-icon-on-svg ' + getSeverityClass(warningHere.severity));
                        icon.textContent = iconChar;
                        icon.style.fontSize = '18px';
                        icon.style.cursor = 'pointer';
                        // æ‚¬åœæ˜¾ç¤ºè¯¦æƒ…
                        icon.addEventListener('mouseover', function(e) {
                          tooltip.style.display = 'block';
                          tooltip.style.left = (e.pageX + 10) + 'px';
                          tooltip.style.top = (e.pageY - 30) + 'px';
                          tooltip.innerHTML = `<b>${warningHere.message}</b><br>${warningHere.details}`;
                        });
                        icon.addEventListener('mousemove', function(e) {
                          tooltip.style.left = (e.pageX + 10) + 'px';
                          tooltip.style.top = (e.pageY - 30) + 'px';
                        });
                        icon.addEventListener('mouseout', function() {
                          tooltip.style.display = 'none';
                        });
                        trainPathsGroupSvg.appendChild(icon);
                    }
                }
            });
        }
        if (pathPoints.length > 0) {
            const path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', 'M' + pathPoints.join(' L'));
            path.setAttribute('class', service.type + '-line-svg');
            if (service.label.includes('ç§Ÿèˆ¹')) {
                path.classList.add('chartered');
            }
            path.dataset.serviceId = service.id;
            if (service.type === 'demand') path.setAttribute('marker-end', 'url(#arrow-demand-svg)');
            else if (service.type === 'planned') path.setAttribute('marker-end', 'url(#arrow-planned-svg)');
            else if (service.type === 'actual') path.setAttribute('marker-end', 'url(#arrow-actual-svg)');
            trainPathsGroupSvg.appendChild(path);

            if (service.label) {
                const lastPointCoords = pathPoints[pathPoints.length - 1].split(',');
                let midX = parseFloat(lastPointCoords[0]);
                let midY = parseFloat(lastPointCoords[1]);

                if (pathPoints.length > 1) {
                    const secondLastPointCoords = pathPoints[Math.max(0, pathPoints.length - 2)].split(',');
                    midX = (parseFloat(secondLastPointCoords[0]) + parseFloat(lastPointCoords[0])) / 2;
                    midY = (parseFloat(secondLastPointCoords[1]) + parseFloat(lastPointCoords[1])) / 2;
                }

                const labelTextElement = document.createElementNS(svgNS, 'text');
                labelTextElement.setAttribute('x', midX);
                labelTextElement.setAttribute('y', midY - 8);
                labelTextElement.setAttribute('class', 'line-label-svg');
                labelTextElement.textContent = `${service.label} (${service.vesselType}, ${service.tonnage})`;
                trainPathsGroupSvg.appendChild(labelTextElement);
            }
        }
    });
  }

  function drawAreaWarnings(warningsToDraw) { /* ... (same as previous, ensure getCellCenter is used correctly) ... */
    if (!warningsToDraw || warningsToDraw === MOCK_WARNINGS) { areaWarningOverlaysGroupSvg.innerHTML = '';}
    else if (warningsToDraw.length > 0) { areaWarningOverlaysGroupSvg.innerHTML = ''; }

    warningsToDraw.forEach(w => {
        const startColIdx = isoToColIdx(w.startTime); const endColIdx = isoToColIdx(w.endTime);
        if (w.type === 'å°æ¸¯' && w.entityType === 'port' && w.entityName && startColIdx !== null && endColIdx !== null) {
            const portInfo = portConfig.find(p => p.name === w.entityName);
            if (portInfo) {
                const firstStateCellInfo = getCellCenter(w.entityName, portInfo.states[0], startColIdx);
                const lastStateCellInfo = getCellCenter(w.entityName, portInfo.states[portInfo.states.length - 1], startColIdx);
                const startXCellInfo = getCellCenter(w.entityName, portInfo.states[0], startColIdx);
                const endXCellInfo = getCellCenter(w.entityName, portInfo.states[0], endColIdx);
                if (firstStateCellInfo && lastStateCellInfo && startXCellInfo && endXCellInfo) {
                    const x = startXCellInfo.centerX - startXCellInfo.element.offsetWidth / 2;
                    const width = (endXCellInfo.centerX + endXCellInfo.element.offsetWidth/2) - x;
                    const y = firstStateCellInfo.centerY - firstStateCellInfo.element.offsetHeight / 2;
                    const height = (lastStateCellInfo.centerY + lastStateCellInfo.element.offsetHeight/2) - y;
                    if (width > 0 && height > 0) {
                        const rect = document.createElementNS(svgNS, 'rect'); rect.setAttribute('x', x); rect.setAttribute('y', y); rect.setAttribute('width', width); rect.setAttribute('height', height); rect.setAttribute('class', `area-warning-overlay-svg port-closure-overlay-svg`); const title = document.createElementNS(svgNS, 'title'); title.textContent = `${w.message}\n${w.details}`; rect.appendChild(title); areaWarningOverlaysGroupSvg.appendChild(rect);
                        const text = document.createElementNS(svgNS, 'text'); text.setAttribute('x', x + width / 2); text.setAttribute('y', y + height / 2); text.setAttribute('class', 'area-warning-text-svg'); text.textContent = `å°: ${w.entityName.slice(0,2)}`; areaWarningOverlaysGroupSvg.appendChild(text);
                    }
                }
            }
        } else if (w.type === 'ç‰¹æ®Šæµ·å†µ' && startColIdx !== null && endColIdx !== null) {
            let yMin = Infinity, yMax = -Infinity;
            if (w.affectedPorts && w.affectedPorts.length > 0) {
                 w.affectedPorts.forEach(pName => { const portInfo = portConfig.find(p => p.name === pName); if(portInfo) { const firstStateCell = getCellCenter(pName, portInfo.states[0], startColIdx); const lastStateCell = getCellCenter(pName, portInfo.states[portInfo.states.length - 1], startColIdx); if(firstStateCell) yMin = Math.min(yMin, firstStateCell.centerY - firstStateCell.element.offsetHeight/2); if(lastStateCell) yMax = Math.max(yMax, lastStateCell.centerY + lastStateCell.element.offsetHeight/2); } });
            } else { const firstPortInfo = portConfig[0]; const lastPortInfo = portConfig[portConfig.length-1]; const firstCell = getCellCenter(firstPortInfo.name, firstPortInfo.states[0], startColIdx); const lastCell = getCellCenter(lastPortInfo.name, lastPortInfo.states[lastPortInfo.states.length-1], startColIdx); if (firstCell) yMin = firstCell.centerY - firstCell.element.offsetHeight/2; if (lastCell) yMax = lastCell.centerY + lastCell.element.offsetHeight/2; }
            if (yMin === Infinity || yMax === -Infinity) { const tableBody = mainGanttTable.tBodies[0] || mainGanttTable; yMin = tableBody.offsetTop || 0; yMax = yMin + (tableBody.offsetHeight || ganttSvgOverlay.viewBox.baseVal.height || 500); }

            const firstTimeCell = getCellCenter(portConfig[0].name, portConfig[0].states[0], startColIdx);
            const lastTimeCell = getCellCenter(portConfig[0].name, portConfig[0].states[0], endColIdx);
            if (firstTimeCell && lastTimeCell && yMax > yMin) {
                const x = firstTimeCell.centerX - firstTimeCell.element.offsetWidth / 2;
                const width = (lastTimeCell.centerX + lastTimeCell.element.offsetWidth / 2) - x;
                const height = yMax - yMin;
                if (width > 0 && height > 0) {
                    const rect = document.createElementNS(svgNS, 'rect'); rect.setAttribute('x', x); rect.setAttribute('y', yMin); rect.setAttribute('width', width); rect.setAttribute('height', height); rect.setAttribute('class', `area-warning-overlay-svg sea-condition-overlay-${w.severity}`); const title = document.createElementNS(svgNS, 'title'); title.textContent = `${w.message}\n${w.details}`; rect.appendChild(title); areaWarningOverlaysGroupSvg.appendChild(rect);
                    const text = document.createElementNS(svgNS, 'text'); text.setAttribute('x', x + width / 2); text.setAttribute('y', yMin + height / 2); text.setAttribute('class', 'area-warning-text-svg'); text.textContent = w.affectedArea || w.type; areaWarningOverlaysGroupSvg.appendChild(text);
                }
            }
        }
    });
  }

  function updateCurrentTimeLine() {
    const now = new Date();
    const currentHour = now.getHours() + now.getMinutes() / 60;
    const colIdx = serviceTimeToColIdx(currentHour);
    
    // ç§»é™¤æ—§çš„æ—¶é—´çº¿
    const oldTimeLine = document.getElementById('currentTimeLine');
    if (oldTimeLine) oldTimeLine.remove();
    
    if (colIdx >= 0 && colIdx < TIME_COLUMNS) {
        const timeLine = document.createElementNS(svgNS, 'line');
        timeLine.id = 'currentTimeLine';
        timeLine.setAttribute('x1', cellInfoMap.get(`cell_${portConfig[0].name}_${portConfig[0].states[0].replace(/[^a-zA-Z0-9\-]/g,'-')}_${colIdx}`).centerX);
        timeLine.setAttribute('y1', 0);
        timeLine.setAttribute('x2', cellInfoMap.get(`cell_${portConfig[0].name}_${portConfig[0].states[0].replace(/[^a-zA-Z0-9\-]/g,'-')}_${colIdx}`).centerX);
        timeLine.setAttribute('y2', ganttSvgOverlay.viewBox.baseVal.height);
        timeLine.setAttribute('stroke', '#ff4444');
        timeLine.setAttribute('stroke-width', '2');
        timeLine.setAttribute('stroke-dasharray', '5,5');
        ganttSvgOverlay.appendChild(timeLine);
    }
  }

  function initializeApp() {
    createGanttTable();
    displayWarnings(MOCK_WARNINGS);
    updateCurrentTimeLine();
    setInterval(updateCurrentTimeLine, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´çº¿
  }

  document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>